services:
  ingress-rpc:
    build:
      context: .
      dockerfile: crates/ingress-rpc/Dockerfile
    container_name: tips-ingress-rpc
    ports:
      - "8080:8080"
    env_file:
      - .env.docker
    restart: unless-stopped

  audit:
    build:
      context: .
      dockerfile: crates/audit/Dockerfile
    container_name: tips-audit
    env_file:
      - .env.docker
    restart: unless-stopped

  maintenance:
    build:
      context: .
      dockerfile: crates/maintenance/Dockerfile
    container_name: tips-maintenance
    env_file:
      - .env.docker
    restart: unless-stopped

  ui:
    build:
      context: .
      dockerfile: ui/Dockerfile
    ports:
      - "3000:3000"
    container_name: tips-ui
    env_file:
      - .env.docker
    restart: unless-stopped

  ingress-writer:
    build:
      context: .
      dockerfile: crates/ingress-writer/Dockerfile
    container_name: tips-ingress-writer
    env_file:
      - .env.docker
    restart: unless-stopped

  simulator:
    build:
      context: .
      dockerfile: crates/simulator/Dockerfile
    container_name: tips-simulator
    volumes:
      - ${TIPS_SIMULATOR_DATADIR}:/data
      - ${TIPS_SIMULATOR_BUILDER_PLAYGROUND_DIR}:/playground
    env_file:
      - .env.docker
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "[ \"$(curl -s -w '%{http_code}' -o /dev/null \"localhost:4444\")\" = \"401\" ]" ]
      interval: 10s
      timeout: 5s
      retries: 10
    profiles:
      - builder

  shadow-boost:
    build:
      context: .
      dockerfile: crates/shadow-boost/Dockerfile
    image: shadow-boost:latest
    container_name: tips-shadow-boost
    depends_on:
      shadow-builder:
        condition: service_started
    profiles:
      - builder
    ports:
      - "8554:8554" # Engine API proxy
    volumes:
      - ~/.playground/devnet/jwtsecret:/data/jwtsecret:ro
    environment:
      BUILDER_URL: http://shadow-builder:4444
      BUILDER_JWT_SECRET: /data/jwtsecret
      LISTEN_ADDR: 0.0.0.0:8554
      TIMEOUT_MS: "2000"
